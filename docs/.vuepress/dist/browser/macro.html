<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>宏观视角下的浏览器</title>
    <meta name="description" content="">
    <link rel="alternate" type="application/rss+xml" href="https://www.banli17.com/rss.xml" title=" RSS Feed">
  <link rel="alternate" type="application/atom+xml" href="https://www.banli17.com/feed.atom" title=" Atom Feed">
  <link rel="alternate" type="application/json" href="https://www.banli17.com/feed.json" title=" JSON Feed">
    
    <link rel="preload" href="/assets/css/0.styles.8ce8701a.css" as="style"><link rel="preload" href="/assets/js/app.c1af5972.js" as="script"><link rel="preload" href="/assets/js/2.c15629b4.js" as="script"><link rel="preload" href="/assets/js/4.ee2c779b.js" as="script"><link rel="prefetch" href="/assets/js/10.84cd2ee0.js"><link rel="prefetch" href="/assets/js/11.048516a6.js"><link rel="prefetch" href="/assets/js/12.27c8e9d4.js"><link rel="prefetch" href="/assets/js/13.4e1c9c9d.js"><link rel="prefetch" href="/assets/js/14.6a8ccbc2.js"><link rel="prefetch" href="/assets/js/15.a233838a.js"><link rel="prefetch" href="/assets/js/16.6f803c96.js"><link rel="prefetch" href="/assets/js/17.2d68d758.js"><link rel="prefetch" href="/assets/js/18.d30f2407.js"><link rel="prefetch" href="/assets/js/19.9d7a4252.js"><link rel="prefetch" href="/assets/js/20.fc60943f.js"><link rel="prefetch" href="/assets/js/21.538cce37.js"><link rel="prefetch" href="/assets/js/22.99742d82.js"><link rel="prefetch" href="/assets/js/23.b98614ea.js"><link rel="prefetch" href="/assets/js/24.5cb0666e.js"><link rel="prefetch" href="/assets/js/25.f2a3d08e.js"><link rel="prefetch" href="/assets/js/26.e1e4c6dc.js"><link rel="prefetch" href="/assets/js/27.c568185a.js"><link rel="prefetch" href="/assets/js/28.1a7848f2.js"><link rel="prefetch" href="/assets/js/29.265dfb62.js"><link rel="prefetch" href="/assets/js/3.6da0ba73.js"><link rel="prefetch" href="/assets/js/30.f5c146f5.js"><link rel="prefetch" href="/assets/js/31.19101f40.js"><link rel="prefetch" href="/assets/js/32.5e603704.js"><link rel="prefetch" href="/assets/js/33.1d324cc6.js"><link rel="prefetch" href="/assets/js/34.054eb64b.js"><link rel="prefetch" href="/assets/js/35.87868f35.js"><link rel="prefetch" href="/assets/js/36.aa53f146.js"><link rel="prefetch" href="/assets/js/37.e37b2a33.js"><link rel="prefetch" href="/assets/js/38.f2d14412.js"><link rel="prefetch" href="/assets/js/39.fd9db076.js"><link rel="prefetch" href="/assets/js/40.913e9709.js"><link rel="prefetch" href="/assets/js/41.0861b9f8.js"><link rel="prefetch" href="/assets/js/42.a06030ad.js"><link rel="prefetch" href="/assets/js/43.7d4c7bcb.js"><link rel="prefetch" href="/assets/js/44.e9431810.js"><link rel="prefetch" href="/assets/js/45.8a0f4fa7.js"><link rel="prefetch" href="/assets/js/46.e2cc3c1b.js"><link rel="prefetch" href="/assets/js/47.4191d998.js"><link rel="prefetch" href="/assets/js/48.b01feb39.js"><link rel="prefetch" href="/assets/js/49.4bba85ef.js"><link rel="prefetch" href="/assets/js/5.2fe29870.js"><link rel="prefetch" href="/assets/js/50.22c83c3d.js"><link rel="prefetch" href="/assets/js/51.86585b9d.js"><link rel="prefetch" href="/assets/js/52.6b2d01a9.js"><link rel="prefetch" href="/assets/js/53.64435c3d.js"><link rel="prefetch" href="/assets/js/54.1d94f1e1.js"><link rel="prefetch" href="/assets/js/55.bbbf88c3.js"><link rel="prefetch" href="/assets/js/56.8895649a.js"><link rel="prefetch" href="/assets/js/57.9576e17d.js"><link rel="prefetch" href="/assets/js/58.10927e17.js"><link rel="prefetch" href="/assets/js/59.1472a223.js"><link rel="prefetch" href="/assets/js/6.6fafa4d1.js"><link rel="prefetch" href="/assets/js/60.7dc3b020.js"><link rel="prefetch" href="/assets/js/61.1adb17bb.js"><link rel="prefetch" href="/assets/js/62.eac27780.js"><link rel="prefetch" href="/assets/js/63.7ff3782d.js"><link rel="prefetch" href="/assets/js/64.6db9e82a.js"><link rel="prefetch" href="/assets/js/65.1c227a96.js"><link rel="prefetch" href="/assets/js/66.b1ea1a79.js"><link rel="prefetch" href="/assets/js/67.3bfbc1f4.js"><link rel="prefetch" href="/assets/js/68.c15cdcd7.js"><link rel="prefetch" href="/assets/js/69.edd27744.js"><link rel="prefetch" href="/assets/js/7.d75a7688.js"><link rel="prefetch" href="/assets/js/70.589290a8.js"><link rel="prefetch" href="/assets/js/71.aea14513.js"><link rel="prefetch" href="/assets/js/72.74969186.js"><link rel="prefetch" href="/assets/js/73.6a17c105.js"><link rel="prefetch" href="/assets/js/74.74a5dbd1.js"><link rel="prefetch" href="/assets/js/75.dccf7f24.js"><link rel="prefetch" href="/assets/js/76.68da0f3a.js"><link rel="prefetch" href="/assets/js/77.af86f8c3.js"><link rel="prefetch" href="/assets/js/8.df4b3174.js"><link rel="prefetch" href="/assets/js/9.62d50e85.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ce8701a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/f2e/html/1.html" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">javascript</a></li><li class="dropdown-item"><!----> <a href="/es6/" class="nav-link">es6</a></li><li class="dropdown-item"><!----> <a href="/jquery/" class="nav-link">jQuery</a></li><li class="dropdown-item"><!----> <a href="/browser/" class="nav-link router-link-active">浏览器</a></li><li class="dropdown-item"><!----> <a href="/project/" class="nav-link">工程化</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sql/" class="nav-link">sql 必知必会</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/mongo/" class="nav-link">mongodb</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/nginx/" class="nav-link">nginx</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/browser/.html" class="nav-link">网络协议</a></li><li class="dropdown-item"><!----> <a href="/browser/.html" class="nav-link">计算机组成原理</a></li><li class="dropdown-item"><!----> <a href="/browser/.html" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algo/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><a href="/task/2020.html" class="nav-link">安排</a></div><div class="nav-item"><a href="https://github.com/banli17" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/f2e/html/1.html" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">javascript</a></li><li class="dropdown-item"><!----> <a href="/es6/" class="nav-link">es6</a></li><li class="dropdown-item"><!----> <a href="/jquery/" class="nav-link">jQuery</a></li><li class="dropdown-item"><!----> <a href="/browser/" class="nav-link router-link-active">浏览器</a></li><li class="dropdown-item"><!----> <a href="/project/" class="nav-link">工程化</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/sql/" class="nav-link">sql 必知必会</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/mongo/" class="nav-link">mongodb</a></li><li class="dropdown-item"><!----> <a href="/language/japanese/" class="nav-link">redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/nginx/" class="nav-link">nginx</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/browser/.html" class="nav-link">网络协议</a></li><li class="dropdown-item"><!----> <a href="/browser/.html" class="nav-link">计算机组成原理</a></li><li class="dropdown-item"><!----> <a href="/browser/.html" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algo/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><a href="/task/2020.html" class="nav-link">安排</a></div><div class="nav-item"><a href="https://github.com/banli17" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器原理</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/browser/" class="sidebar-link">/browser/</a></li><li><a href="/browser/macro.html" class="active sidebar-link">宏观视角下的浏览器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/browser/macro.html#chrome-架构" class="sidebar-link">Chrome 架构</a></li><li class="sidebar-sub-header"><a href="/browser/macro.html#tcp-协议" class="sidebar-link">TCP 协议</a></li><li class="sidebar-sub-header"><a href="/browser/macro.html#http-请求流程" class="sidebar-link">HTTP 请求流程</a></li><li class="sidebar-sub-header"><a href="/browser/macro.html#导航流程" class="sidebar-link">导航流程</a></li><li class="sidebar-sub-header"><a href="/browser/macro.html#渲染流程" class="sidebar-link">渲染流程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="宏观视角下的浏览器"><a href="#宏观视角下的浏览器" aria-hidden="true" class="header-anchor">#</a> 宏观视角下的浏览器</h1> <h2 id="chrome-架构"><a href="#chrome-架构" aria-hidden="true" class="header-anchor">#</a> Chrome 架构</h2> <p>查看 Chrome 进程情况： Chrome 又上角选项 -&gt; 更多工具 -&gt; 任务管理器。</p> <p>并行处理：同一时刻处理多个任务。举例:</p> <div class="language- extra-class"><pre class="language-text"><code>A = 1+1
B = 2*3
C = A*B
</code></pre></div><p>单线程从上到下计算，多线程同时计算 A、B，最后计算 C，性能提高了。</p> <p>线程：不能单独存在，由进程来启动和管理。
进程：一个进程就是一个程序的运行实例，启动程序时，操作系统会为程序分配内存，用来存放代码、运行时数据和一个执行任务的主线程，这样的一个运行环境叫做进程。</p> <p>线程依附于进程，而进程中使用多线程能并行处理提升运算效率。</p> <p>关系：</p> <ol><li>进程中任意线程出错，都会导致整个进程崩溃。如 B 计算 1/0 出错。</li> <li>线程之间共享进程的数据。</li> <li>进程关闭后，操作系统回收所占用的内存。</li> <li>进程之间的内容相互隔离。一个进程崩溃，不会影响其它进程。进程通信需要 IPC 机制。</li></ol> <p>单进程浏览器：网络、插件、js 运行环境、渲染引擎和页面都在一个进程。问题：</p> <ol><li>不稳定</li> <li>不流畅</li> <li>不安全：运行插件可以获取操作系统的任意资源。恶意插件可以释放病毒，盗取密码。页面脚本也可以通过浏览器漏洞获取系统权限。</li></ol> <p>多进程浏览器</p> <p><img src="/assets/img/1-1-0.cdc9215e.png" alt=""></p> <p>解决不稳定：多进程
不流畅：js 运行在渲染进程中，即使阻塞进程，也只影响当前渲染页面，而不会影响浏览器和其它页面。
安全问题：安全沙箱，即沙箱里的程序可以运行，单不能在硬盘上写入数据，也不能读取敏感位置的数据。插件进程和渲染进程在沙箱中。</p> <p>目前多进程架构</p> <p><img src="/assets/img/1-2-0.b61cab52.png" alt=""></p> <ul><li>浏览器进程： 负责界面显示、用户交互、子进程管理、提供存储等功能。</li> <li>渲染进程：将 html/css/js 转为用户可交互的网页，排版引擎 Blick 和 js 引擎 v8 都在该进程中，默认 Chrome 会给每个同站点页面共享一个渲染进程(process-per-site-instance，<a href="http://www.chromium.org/developers/design-documents/process-models" target="_blank" rel="noopener noreferrer">查看更多<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。运行在沙箱模式下。</li> <li>GPU 进程: 初衷是为了实现 3D CSS，后来网页、Chrome UI 界面都采用 GPU 来绘制。</li> <li>网络进程</li> <li>插件进程</li></ul> <p>多进程模型的问题：</p> <ul><li>更高的资源占用。每个进程都包含公共基础结构的副本(如 js 运行环境)。</li> <li>更复杂的体系架构：浏览器各模块之间耦合性高，扩展性差。</li></ul> <p>面向未来服务的架构</p> <p>2016 年,Chrome 提出了 <strong>面向服务的架构</strong>(Services Oriented Architecture，简称 SOA)。将原来各种模块重构为独立的服务，每个服务都可以在独立的进程中运行，访问服务必须使用定义好的接口，通过 IPC 通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统。</p> <p><img src="/assets/img/1-2-1.329658fe.png" alt=""></p> <p>同时，如果资源受限制的设备上，Chrome 会整合服务到一个进程中，节省内存。</p> <p><img src="/assets/img/1-2-2.a9ba86d7.png" alt=""></p> <ul><li><a href="https://v8.dev/" target="_blank" rel="noopener noreferrer">v8 官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.chromium.org/developers" target="_blank" rel="noopener noreferrer">chrome 设计文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="tcp-协议"><a href="#tcp-协议" aria-hidden="true" class="header-anchor">#</a> TCP 协议</h2> <p>FP(first paint): 从页面加载到首次开始绘制的时长。这个指标直接影响用户跳出率。</p> <p>大数据拆成小数据包来传输。数据包从 A 到 B 传输过程：</p> <ol><li>ip: 数据包要在互联网传输，就要符合网际协议(internet protocol, ip)标准。</li> <li>数据包交给网络层，网络层给数据包附加 ip 头， 包括 ip 版本， 源 ip ，目标 ip，生存时间。</li> <li>通过物理网络传输给 B。</li> <li>B 网络层拆开数据包 ip 头，将数据交给应用层。</li></ol> <p>ip 将数据包发给指定的电脑。
UDP（user datagram protocol) 用户数据包协议，通过端口号将数据给指定程序。</p> <p>UDP 可以校验数据是否正确，但是对错误的包，不提供重发机制，不知道数据是否到达 B，也不能重组包。传输速度快，适合在线视频，互动游戏。
但是有些数据需要安全的到达，所以有了 TCP。
TCP: transmission control protocol，传输控制协议，面向连接、可靠的、基于字节流的传输层协议。
特点：</p> <ul><li>对于数据包丢失，重传机制</li> <li>数据包排序机制，将乱序数据包重组为完整的包</li></ul> <p>完整的 TCP 生命周期：</p> <ul><li>连接三次握手 时序图</li> <li>传输数据</li> <li>断开：四次挥手</li></ul> <h2 id="http-请求流程"><a href="#http-请求流程" aria-hidden="true" class="header-anchor">#</a> HTTP 请求流程</h2> <p>浏览器发起 http 请求过程：</p> <ol><li>构建请求： 构建请求头信息</li></ol> <div class="language- extra-class"><pre class="language-text"><code>GET /index.html HTTP1.1
</code></pre></div><ol start="2"><li>查找缓存：有缓存则直接返回该资源的副本，并直接结束请求。好处：减少服务器压力，提升资源加载速度。</li> <li>缓存查找失败，开始网络请求。</li> <li>为数据传输准备 ip 和端口。
<ul><li>DNS (domain name system)将 url 映射成 ip。</li> <li>有 DNS 数据缓存服务</li> <li>得到 ip</li> <li>根据 url 得到端口号，默认 80</li></ul></li> <li>等待 TCP 队列，chrome 默认同一个域名最多 6 个 TCP 连接。如果小于 6 则建立 TCP 连接。</li> <li>建立 TCP 连接。</li> <li>TCP 传输数据，即发送 HTTP 请求，包括请求方法、url，http 版本、请求头、请求体(post)。http 请求报文格式：</li></ol> <p><img src="/assets/img/b8993c73f7b60feb9b8bd147545c47d7.b8993c73.png" alt=""></p> <ol start="8"><li>服务器处理 HTTP 请求，返回响应，包括协议版本、状态码、服务器信息等。</li></ol> <p><img src="/assets/img/3e30476a4bbda49fd7cd4fd0ea09f076.3e30476a.png" alt=""></p> <ol start="9"><li>断开连接：一旦服务器返回请求数据，就要关闭 TCP 连接，不过可以在头信息中加入 <code>Connection: Keep-Alive</code> 保持连接复用 TCP，这样可以省去下次连接的开销。</li> <li>重定向，如果状态码是 301 ，就是告诉浏览器要重定向，浏览器获取响应头的 Location，重新导航这个地址。</li></ol> <p>为什么很多站点第二次打开速度会很快？</p> <p>因为有缓存: DNS 缓存，页面缓存。</p> <p>缓存查找过程：
服务器返回 http 响应给浏览器，浏览器通过响应头 Cache-Control 设置是否缓存资源，时长通过 Cache-Control 里的 Max-age 设置。</p> <div class="language- extra-class"><pre class="language-text"><code>Cache-Control: Max-age=2000
</code></pre></div><p>如果缓存资源未过期，则直接返回，如果过期了，则发起网络请求，并在 HTTP 请求头带上</p> <div class="language- extra-class"><pre class="language-text"><code>If-None-Match:&quot;4f80f-13c-3a1xb12a&quot;
</code></pre></div><p>服务器收到后，会根据 If-None-Match 值判断请求的资源是否有更新。
没更新就返回 304，表示该缓存可以继续用。
有更新就返回资源给浏览器。</p> <p>登录状态如何保持？</p> <p>用户 post 账户密码
服务器返回头 <code>Set-Cookie: UID=3431uad;</code>给浏览器。
浏览器会保存到本地，再次访问时，会将<code>Cookie: UID=3431uad;</code>发送给服务器。
服务器根据 Cookie 判断用户是否登录。</p> <p>disk：新 tab 打开时，都是 disk；html 文件都是 disk
memory：新 tab 再次使用缓存时，是 memory</p> <p>完整的示意图</p> <p><img src="/assets/img/1b49976aca2c700883d48d927f48986c.1b49976a.png" alt=""></p> <p>http 请求的 8 个阶段: 构建请求、查找缓存、准备 IP 和端口、发起 TCP 连接、发送 HTTP 请求、服务器处理请求、服务器返回请求和端口连接。</p> <p>如果一个页面的网络加载时间过久，你是如何分析卡在哪个阶段的?
https://developers.google.com/web/tools/chrome-devtools/network/reference#timing-explanation 举个例子 Content Download 如果太长，很有可能是下载的资源太大，但也有可能是网络慢导致的下载太慢，简单计算一下，在例如 Waiting (TTFB) 这个太长的话，有可能是网络慢，或者就是 后端处理时间过长导致的，至少可以排查掉前端原因，还有很多，例如 DNS lookup 等，但是最终要确认具体哪里慢，最好是结合系统日志去分析</p> <h2 id="导航流程"><a href="#导航流程" aria-hidden="true" class="header-anchor">#</a> 导航流程</h2> <p>从输入 URL 到页面展示，这中间发生了什么？</p> <p><img src="/assets/img/92d73c75308e50d5c06ad44612bcb45d.92d73c75.png" alt=""></p> <ul><li>浏览器进程收到用户输入的 URL 请求，将该 URL 转发给网络进程。</li> <li>网络进程发起 URL 请求。</li> <li>网络进程收到响应头数据，解析并将数据转发给浏览器进程。</li> <li>浏览器进程收到网络进程的响应头数据后，发送<code>提交导航</code>(CommitNavigation)消息(会携带响应头等基本信息)到渲染进程。</li> <li>渲染进程收到消息后，开始准备接收 HTML 数据，接收方式是直接和网络进程建立数据管道。</li> <li>渲染进程向浏览器进程<code>确认提交</code>，告诉浏览器已经准备好接收和解析数据。</li> <li>浏览器进程收到渲染进程<code>提交文档</code>的消息后，移除之前旧文档，更新浏览器进程中的页面状态。</li></ul> <p>其中，用户发起 url 请求到页面开始解析的过程，叫做导航。</p> <ol><li><p>用户输入</p> <ul><li>输入搜索内容: 和浏览器默认搜索引擎合成 URL。</li> <li>输入请求 URL: 加协议等，合成完整的 URL。</li></ul></li> <li><p>回车</p> <ul><li>清理旧页面， beforeunload 事件可以做数据清理或询问用户是否要离开。</li> <li>标签页图标变成加载状态，页面还是之前的页面，需要等提交文档阶段，页面内容才会替换。</li></ul></li> <li><p>URL 请求过程</p> <ul><li><p>浏览器进程通过 IPC 把 URL 发给网络进程</p></li> <li><p>网络进程查找缓存，有则直接返回，没有则网络请求(DNS 解析，如果是 HTTPS 还要建立 TLS)</p></li> <li><p>利用 IP 和服务器建立 TCP 连接，浏览器端构建请求行、请求头等信息，发给服务器</p></li> <li><p>服务器收到后，生成响应数据，发给网络进程，网络进程收到响应行和响应头开始解析</p> <ul><li><p>处理状态码</p> <ul><li>重定向： 301 或 302，读 Location，重新导航请求</li> <li>200 浏览器继续处理请求</li></ul></li> <li><p>处理响应类型</p> <ul><li>Content-Type: 响应体数据是什么类型
<ul><li><code>application/octet-stream</code>: 字节流，按下载类型处理，同时该 url 请求导航流程结束</li> <li><code>text/html</code>: 继续导航</li></ul></li></ul></li> <li><p>准备渲染进程：</p> <ul><li>每个标签对应一个渲染进程（左键点击才算，右键新开会新开渲染进程)</li> <li>同一站点(same-site)： 根域名、协议相同。新页面会复用父页面的渲染进程,process-per-site-instance。</li> <li>使用 noopener noreferrer 就是告诉浏览器，新打开的子窗口不需要访问父窗口的任何内容，这是为了防止一些钓鱼网站窃取父窗口的信息。会新开渲染进程</li></ul></li> <li><p>提交文档，浏览器进程将网络进程数据交给渲染进程</p> <ul><li>浏览器进程收到网络进程的响应头数据后，向渲染进程发起<code>提交文档</code>的消息。</li> <li>渲染进程收到消息，会和网络进程建立传输数据的管道。</li> <li>数据传输完成，渲染进程返回<code>确认提交</code>消息给浏览器进程。</li> <li>浏览器进程收到消息，更新浏览器界面状态，包括安全状态、地址栏 URL、前进后退的历史状态，并更新 web 页面。</li></ul></li> <li><p>渲染阶段：渲染进程开始页面解析和子资源加载</p></li></ul></li></ul></li></ol> <h2 id="渲染流程"><a href="#渲染流程" aria-hidden="true" class="header-anchor">#</a> 渲染流程</h2> <ul><li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part1" target="_blank" rel="noopener noreferrer">深入了解现代 Web 浏览器（第 1 部分）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/browser/" class="prev router-link-active">
          /browser/
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c1af5972.js" defer></script><script src="/assets/js/2.c15629b4.js" defer></script><script src="/assets/js/4.ee2c779b.js" defer></script>
  </body>
</html>
